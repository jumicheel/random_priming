---
title: "BioAnalyzer_random_priming"
author: "Julia Micheel"
date: "2023-09-28"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Fragment analysis after artificial RNA reverse transcription

Low range ssRNA ladder (New England BioLabs, USA) was diluted to 20 ng µl-1 and 5 ng µl-1, incubated at 90°C for 3 min and immediately placed on ice afterwards. 1 µl of the respective dilution was used as input material or SMART-seq3-adapted lysis and reverse transcription as described above in three technical replicates per condition. cDNAs were generated using 0.5 µM of the random 6mer or the random 18mer (Table 1) or a mixture of 0.25 µM of both primers each. cDNAs were pre-amplified as described above and cleaned up using SPRIselect beads in a 3x ratio. After two washing steps with 80% EtOH p.a., the cDNA was eluted in 10 µl nuclease-free water. Samples were quantified by Qubit dsDNA HS and diluted in the same ratio per input amount. Library size distributions of the diluted samples were analyzed with Bioanalyzer using the High Sensitivity DNA kit. Raw data was extracted and analyzed here. Input data for this R script: bioanalyzer_data.RData 


```{r}
library(tidyverse)
library(janitor)
library(bioanalyzeR)
library(XML)
library(ggpubr)
library(ggh4x)
library(rstatix)
library(car)
library(effsize)
library(ggsignif)
```


Ribbon Plots with mean fluorescence unit (FU) (scaled) of the three technical replicates per fragment length bin
```{r}
############# 5 ng Input Amount

#transform electrophoresis data set into data frame
electrophoresis_5ng$data <- cbind(electrophoresis_5ng$data, electrophoresis_5ng$samples[electrophoresis_5ng$data$sample.index,])
electrophoresis_5ng$data$x.value <- electrophoresis_5ng$data[["length"]]
lower.marker.spread = 10
electrophoresis_5ng$data$y.normalized <- electrophoresis_5ng$data$molarity
electrophoresis_5ng$data$y.scaled <- differential.scale(electrophoresis_5ng, "length", "y.normalized")

#filter and bin data
dat_5ng <- electrophoresis_5ng$data
dat_5ng <- dat_5ng %>% drop_na(length) 
dat_5ng <- dat_5ng %>% dplyr::filter(length >= 75 & length <= 1000)
dat_5ng$length_bins <- ifelse(dat_5ng$x.value >= 75 & dat_5ng$x.value <= 200, "75bp-200bp", dat_5ng$x.value)
dat_5ng$length_bins <- ifelse(dat_5ng$x.value >= 200 & dat_5ng$x.value <= 500, "200bp-500bp", dat_5ng$length_bins)
dat_5ng$length_bins <- ifelse(dat_5ng$x.value >= 500 & dat_5ng$x.value <= 1000, "500bp-1000bp", dat_5ng$length_bins)
dat_5ng$length_bins <- factor(dat_5ng$length_bins, levels=c("75bp-200bp", "200bp-500bp", "500bp-1000bp"))

#mean calculation for ribbon plot
dat5ng <- dat_5ng %>% 
  mutate(new_bin = cut(length, breaks=seq(75, 1000, 5))) %>% 
  group_by(primer, new_bin) %>% 
  mutate(mean_y.scaled_perbin = mean(y.scaled),
         sd_y.scaled_perbin = sd(y.scaled)) %>% 
  ungroup() %>% 
  mutate(new_bin = str_replace_all(new_bin, pattern = ",", replacement = "-"),
       new_bin = str_replace_all(new_bin, pattern = "\\(", replacement = ""),
       new_bin = str_replace_all(new_bin, pattern = "\\]", replacement = "")) %>% 
  dplyr::filter(!is.na(primer))

#apply factors to order bins
dat5ng$new_bin <- factor(dat5ng$new_bin, levels = c("75-80",    "80-85",    "85-90",    "90-95",    "95-100",   "100-105",  "105-110",  "110-115",  "115-120",  "120-125",  "125-130",  "130-135",  "135-140", "140-145",  "145-150",  "150-155",  "155-160",  "160-165",  "165-170",  "170-175",  "175-180",  "180-185",  "185-190",  "190-195",  "195-200",  "200-205", "205-210",  "210-215",  "215-220",  "220-225",  "225-230",  "230-235",  "235-240",  "240-245",  "245-250",  "250-255",  "255-260",  "260-265",  "265-270", "270-275",  "275-280",  "280-285",  "285-290",  "290-295",  "295-300",  "300-305",  "305-310",  "310-315",  "315-320",  "320-325",  "325-330",  "330-335", "335-340",  "340-345",  "345-350",  "350-355",  "355-360",  "360-365",  "365-370",  "370-375",  "375-380",  "380-385",  "385-390",  "390-395",  "395-400", "400-405",  "405-410",  "410-415",  "415-420",  "420-425",  "425-430",  "430-435",  "435-440",  "440-445",  "445-450",  "450-455",  "455-460",  "460-465", "465-470",  "470-475",  "475-480",  "480-485",  "485-490",  "490-495",  "495-500",  "500-505",  "505-510",  "510-515",  "515-520",  "520-525",  "525-530", "530-535",  "535-540",  "540-545",  "545-550",  "550-555",  "555-560",  "560-565",  "565-570",  "570-575",  "575-580",  "580-585",  "585-590",  "590-595", "595-600",  "600-605",  "605-610",  "610-615",  "615-620",  "620-625",  "625-630",  "630-635",  "635-640",  "640-645",  "645-650",  "650-655",  "655-660", "660-665",  "665-670",  "670-675",  "675-680",  "680-685",  "685-690",  "690-695",  "695-700",  "700-705",  "705-710",  "710-715",  "715-720",  "720-725", "725-730",  "730-735",  "735-740",  "740-745",  "745-750",  "750-755",  "755-760",  "760-765",  "765-770",  "770-775",  "775-780",  "780-785",  "785-790", "790-795",  "795-800",  "800-805",  "805-810",  "810-815",  "815-820",  "820-825",  "825-830",  "830-835",  "835-840",  "840-845",  "845-850",  "850-855", "855-860",  "860-865",  "865-870",  "870-875",  "875-880",  "880-885",  "885-890",  "890-895",  "895-900",  "900-905",  "905-910",  "910-915",  "915-920", "920-925",  "925-930",  "930-935",  "935-940",  "940-945",  "945-950",  "950-955",  "955-960",  "960-965",  "965-970",  "970-975",  "975-980",  "980-985", "985-990",  "990-995",  "995-1000"))

dat5ng$length_bins <- factor(dat5ng$length_bins, levels=c("75bp-200bp", "200bp-500bp", "500bp-1000bp"))

 plot_5ng <- dat5ng %>%  ggplot(aes(x=new_bin, y=mean_y.scaled_perbin, color=primer, group = primer)) + 
  geom_line(linetype = 1,
            alpha = 1) +
  geom_ribbon(aes(ymin = mean_y.scaled_perbin - sd_y.scaled_perbin,
                  ymax = mean_y.scaled_perbin + sd_y.scaled_perbin,
                  fill = primer),
                  color = NA,
                  alpha = 0.2) +
  scale_color_manual("legend", values = c("6mer" = "#4477AA", "18mer" = "#AA3377", "mix" = "black")) +
  scale_fill_manual("legend", values = c("6mer" = "#4477AA", "18mer" = "#AA3377", "mix" = "darkgrey")) +
  theme_pubclean() +
  facet_wrap(~length_bins, scales = "free") +
  xlab("fragment length (bp)") + 
  ylab("mean FU (scaled") +
  ggh4x::facetted_pos_scales(y = list(
    length_bins == "75bp-200bp" ~ scale_y_continuous(limits = c(0, NA)),
    length_bins == "200bp-500bp" ~ scale_y_continuous(limits = c(0, NA)),
    length_bins == "500bp-1000bp" ~ scale_y_continuous(limits = c(0, NA), breaks=c(1, 3, 5, 7)))) +
  theme(strip.background = element_blank(), strip.text.x = element_blank(), axis.text.x = element_text(angle = 90))
 
 plot_5ng
 
########################################################################
############# 20 ng Input Amount

electrophoresis_20ng$data <- cbind(electrophoresis_20ng$data, electrophoresis_20ng$samples[electrophoresis_20ng$data$sample.index,])
electrophoresis_20ng$data$x.value <- electrophoresis_20ng$data[["length"]]
lower.marker.spread = 10
electrophoresis_20ng$data$y.normalized <- electrophoresis_20ng$data$molarity
electrophoresis_20ng$data$y.scaled <- differential.scale(electrophoresis_20ng, "length", "y.normalized")
dat_20ng <- electrophoresis_20ng$data
dat_20ng <- dat_20ng %>% drop_na(length) %>% dplyr::filter(length >= 75 & length <= 1000)
dat_20ng$length_bins <- ifelse(dat_20ng$x.value >= 75 & dat_20ng$x.value <= 200, "75bp-200bp", dat_20ng$x.value)
dat_20ng$length_bins <- ifelse(dat_20ng$x.value >= 200 & dat_20ng$x.value <= 400, "200bp-500bp", dat_20ng$length_bins)
dat_20ng$length_bins <- ifelse(dat_20ng$x.value >= 400 & dat_20ng$x.value <= 1000, "500bp-1000bp", dat_20ng$length_bins)

dat20ng <- dat_20ng %>% 
  mutate(new_bin = cut(length, breaks=seq(75, 1000, 5))) %>% 
  group_by(primer, new_bin) %>% 
  mutate(mean_y.scaled_perbin = mean(y.scaled),
         sd_y.scaled_perbin = sd(y.scaled)) %>% 
  ungroup() %>% 
  mutate(new_bin = str_replace_all(new_bin, pattern = ",", replacement = "-"),
       new_bin = str_replace_all(new_bin, pattern = "\\(", replacement = ""),
       new_bin = str_replace_all(new_bin, pattern = "\\]", replacement = "")) %>% 
  dplyr::filter(!is.na(primer))

dat20ng$new_bin <- factor(dat20ng$new_bin, levels = c("75-80",    "80-85",    "85-90",    "90-95",    "95-100",   "100-105",  "105-110",  "110-115",  "115-120",  "120-125",  "125-130",  "130-135",  "135-140", "140-145",  "145-150",  "150-155",  "155-160",  "160-165",  "165-170",  "170-175",  "175-180",  "180-185",  "185-190",  "190-195",  "195-200",  "200-205", "205-210",  "210-215",  "215-220",  "220-225",  "225-230",  "230-235",  "235-240",  "240-245",  "245-250",  "250-255",  "255-260",  "260-265",  "265-270", "270-275",  "275-280",  "280-285",  "285-290",  "290-295",  "295-300",  "300-305",  "305-310",  "310-315",  "315-320",  "320-325",  "325-330",  "330-335", "335-340",  "340-345",  "345-350",  "350-355",  "355-360",  "360-365",  "365-370",  "370-375",  "375-380",  "380-385",  "385-390",  "390-395",  "395-400", "400-405",  "405-410",  "410-415",  "415-420",  "420-425",  "425-430",  "430-435",  "435-440",  "440-445",  "445-450",  "450-455",  "455-460",  "460-465", "465-470",  "470-475",  "475-480",  "480-485",  "485-490",  "490-495",  "495-500",  "500-505",  "505-510",  "510-515",  "515-520",  "520-525",  "525-530", "530-535",  "535-540",  "540-545",  "545-550",  "550-555",  "555-560",  "560-565",  "565-570",  "570-575",  "575-580",  "580-585",  "585-590",  "590-595", "595-600",  "600-605",  "605-610",  "610-615",  "615-620",  "620-625",  "625-630",  "630-635",  "635-640",  "640-645",  "645-650",  "650-655",  "655-660", "660-665",  "665-670",  "670-675",  "675-680",  "680-685",  "685-690",  "690-695",  "695-700",  "700-705",  "705-710",  "710-715",  "715-720",  "720-725", "725-730",  "730-735",  "735-740",  "740-745",  "745-750",  "750-755",  "755-760",  "760-765",  "765-770",  "770-775",  "775-780",  "780-785",  "785-790", "790-795",  "795-800",  "800-805",  "805-810",  "810-815",  "815-820",  "820-825",  "825-830",  "830-835",  "835-840",  "840-845",  "845-850",  "850-855", "855-860",  "860-865",  "865-870",  "870-875",  "875-880",  "880-885",  "885-890",  "890-895",  "895-900",  "900-905",  "905-910",  "910-915",  "915-920", "920-925",  "925-930",  "930-935",  "935-940",  "940-945",  "945-950",  "950-955",  "955-960",  "960-965",  "965-970",  "970-975",  "975-980",  "980-985", "985-990",  "990-995",  "995-1000"))

dat20ng$length_bins <- factor(dat20ng$length_bins, levels=c("75bp-200bp", "200bp-500bp", "500bp-1000bp"))

 plot_20ng <- dat20ng %>%  ggplot(aes(x=new_bin, y=mean_y.scaled_perbin, color=primer, group = primer)) + 
  geom_line(linetype = 1,
            alpha = 1) +
  geom_ribbon(aes(ymin = mean_y.scaled_perbin - sd_y.scaled_perbin,
                  ymax = mean_y.scaled_perbin + sd_y.scaled_perbin,
                  fill = primer),
                  color = NA,
                  alpha = 0.2) +
  scale_color_manual("legend", values = c("6mer" = "#4477AA", "18mer" = "#AA3377", "mix" = "black")) +
  scale_fill_manual("legend", values = c("6mer" = "#4477AA", "18mer" = "#AA3377", "mix" = "darkgrey")) +
  theme_pubclean() +
  facet_wrap(~length_bins, scales = "free") +
  xlab("fragment length (bp)") + 
  ylab("mean FU (scaled") +
  ggh4x::facetted_pos_scales(y = list(
    length_bins == "75bp-200bp" ~ scale_y_continuous(limits = c(0, NA)),
    length_bins == "200bp-500bp" ~ scale_y_continuous(limits = c(0, NA)),
    length_bins == "500bp-1000bp" ~ scale_y_continuous(limits = c(0, NA), breaks=c(1, 3, 5, 7)))) +
  theme(strip.background = element_blank(), strip.text.x = element_blank(), axis.text.x = element_text(angle = 90))
 
  plot_20ng
```
Box plots of the mean FU (scaled) per technical replicate per fragment length bin

```{r}
primers <- c("6mer", "18mer", "mix")

ng5_bin_y_scaled <- dat_5ng %>% 
  group_by(sample.name, length_bins) %>%  
  summarise(bin_sum = sum(y.scaled)) 

ng5_bin_y_scaled$sample.name <- gsub(pattern = "sample 1", "5ng_6mer2", ng5_bin_y_scaled$sample.name)
ng5_bin_y_scaled$sample.name <- gsub(pattern = "sample 2", "5ng_6mer3", ng5_bin_y_scaled$sample.name)
ng5_bin_y_scaled$sample.name <- gsub(pattern = "sample 3", "5ng_18mer2", ng5_bin_y_scaled$sample.name)
ng5_bin_y_scaled$sample.name <- gsub(pattern = "sample 4", "5ng_18mer3", ng5_bin_y_scaled$sample.name)
ng5_bin_y_scaled$sample.name <- gsub(pattern = "sample 5", "5ng_mix2", ng5_bin_y_scaled$sample.name)
ng5_bin_y_scaled$sample.name <- gsub(pattern = "sample 6", "5ng_mix3", ng5_bin_y_scaled$sample.name)

ng5_bin_y_scaled$replicate <- ng5_bin_y_scaled$sample.name
ng5_bin_y_scaled$sample.name <-  gsub(".{1}$","", ng5_bin_y_scaled$sample.name)
ng5_bin_y_scaled$sample.name <- factor(ng5_bin_y_scaled$sample.name, levels= c("5ng_6mer", "5ng_18mer", "5ng_mix"))

ng5_bin_y_scaled$length_bins <- factor(ng5_bin_y_scaled$length_bins, levels= c("75bp-200bp", "200bp-500bp", "500bp-1000bp"))

ng5_box <- ng5_bin_y_scaled %>% 
  ggplot(., aes(x = sample.name, y = bin_sum, fill=sample.name, color = sample.name, alpha = sample.name)) + 
  geom_boxplot() + 
  geom_dotplot(binaxis='y', stackdir='center', dotsize=1, alpha=1, color = "black") +
  scale_fill_manual("legend", values = c("5ng_6mer" = "#4477AA", "5ng_18mer" = "#AA3377", "5ng_mix" = "black")) +
  scale_color_manual("legend", values = c("5ng_6mer" = "#4477AA", "5ng_18mer" = "#AA3377", "5ng_mix" = "black")) +
  scale_alpha_manual(values = c(0.4,0.4,0.4)) + 
  geom_signif(comparisons = list(c("5ng_6mer", "5ng_18mer"), c("5ng_6mer", "5ng_mix"), c("5ng_18mer", "5ng_mix")),
              test = "t.test", test.args = list(var.equal = T),
              map_signif_level = TRUE, tip_length = 0.02, aes(x = sample.name, y = bin_sum), vjust = 0.1, inherit.aes = FALSE, step_increase = 0.1) +
  facet_wrap(.~ length_bins, scales = "free_y") +
  #scale_y_continuous(trans = "log10" ) + 
  labs(title="", x="", y="mean FU (scaled)") +
  theme_classic() +
  theme(legend.position = "none", axis.text.x = element_text(angle = 45, vjust=0.7)) +
  scale_x_discrete(labels = primers)
#ng5_box

ng5_box_stat <- ggplot_build(ng5_box)
#annotations based on the results of the geom_signif function and the results shown in the summarizing table of statistical tests in the last code chunk of this markdown file
ng5_box_stat$data[[3]]$annotation <- c(rep("n.s.",3),rep("n.s.",3),rep("n.s.",3), rep("n.s.",3), rep("n.s.",3), rep("n.s.",3), rep("**",3), rep("*",3), rep("n.s.",3))
## Reconstruct plot
ng5_box_stat <- ggplot_gtable(ng5_box_stat)
plot(ng5_box_stat)


#########


ng20_bin_y_scaled <- dat_20ng %>% 
  group_by(sample.name, length_bins) %>%  
  summarise(bin_sum = sum(y.scaled)) 

ng20_bin_y_scaled$sample.name <-  gsub("20ng_mix13","20ng_mix3", ng20_bin_y_scaled$sample.name)

ng20_bin_y_scaled$replicate <- ng20_bin_y_scaled$sample.name
ng20_bin_y_scaled$sample.name <-  gsub(".{1}$","", ng20_bin_y_scaled$sample.name)
ng20_bin_y_scaled$sample.name <- factor(ng20_bin_y_scaled$sample.name, levels= c("20ng_6mer", "20ng_18mer", "20ng_mix"))

ng20_bin_y_scaled$length_bins <- factor(ng20_bin_y_scaled$length_bins, levels= c("75bp-200bp", "200bp-500bp", "500bp-1000bp"))

ng20_box <- ng20_bin_y_scaled %>% 
  ggplot(., aes(x = sample.name, y = bin_sum, fill=sample.name, color = sample.name, alpha = sample.name)) + 
  geom_boxplot() + 
  geom_dotplot(binaxis='y', stackdir='center', dotsize=1, alpha=1, color = "black") +
  scale_fill_manual("legend", values = c("20ng_6mer" = "#4477AA", "20ng_18mer" = "#AA3377", "20ng_mix" = "black")) +
  scale_color_manual("legend", values = c("20ng_6mer" = "#4477AA", "20ng_18mer" = "#AA3377", "20ng_mix" = "black")) +
  scale_alpha_manual(values = c(0.4,0.4,0.4)) + 
  geom_signif(comparisons = list(c("20ng_6mer", "20ng_18mer"), c("20ng_6mer", "20ng_mix"), c("20ng_18mer", "20ng_mix")),
              test = "t.test", test.args = list(var.equal = T),
              map_signif_level = TRUE, tip_length = 0.02, aes(x = sample.name, y = bin_sum), vjust = 0.1, inherit.aes = FALSE, step_increase = 0.1) +
  facet_wrap(.~ length_bins, scales = "free_y") +
  #scale_y_continuous(trans = "log10" ) + 
  labs(title="", x="", y="mean FU (scaled)") +
  theme_classic() +
  theme(legend.position = "none", axis.text.x = element_text(angle = 45, vjust=0.7)) +
  scale_x_discrete(labels = primers)
#ng20_box

ng20_box_stat <- ggplot_build(ng20_box)
#annotations based on the results of the geom_signif function and the results shown in the summarizing table of statistical tests in the last code chunk of this markdown file
ng20_box_stat$data[[3]]$annotation <- c(rep("n.s.",3),rep("n.s.",3),rep("n.s.",3), rep("n.s.",3), rep("*",3), rep("n.s.",3), rep("n.s.",3), rep("n.s.",3), rep("n.s.",3))
## Reconstruct plot
ng20_box_new <- ggplot_gtable(ng20_box_stat)
plot(ng20_box_new)
```


```{r}
ng5_df <- ng5_bin_y_scaled %>% pivot_wider(values_from = bin_sum, names_from = length_bins, id_cols = replicate)
ng20_df <- ng20_bin_y_scaled %>% pivot_wider(values_from = bin_sum, names_from = length_bins, id_cols = replicate)
ng5_df$primer <-  as.factor(str_remove(ng5_df$replicate, "\\d+$"))
ng20_df$primer <-  as.factor(str_remove(ng20_df$replicate, "\\d+$"))
colnames(ng5_df)[2:4] <- c("x75bp-200bp", "x200bp-500bp", "x500bp-1000bp")
colnames(ng20_df)[2:4] <- c("x75bp-200bp", "x200bp-500bp", "x500bp-1000bp")
ng5_df <- ng5_df %>% arrange(primer)
ng20_df <- ng20_df %>% arrange(primer)

t_results <- c()
for (i in colnames(ng5_df)[c(3, 4)]){
formula <- reformulate("primer", response = i)
pwc <- ng5_df %>% pairwise_t_test(formula, pool.sd = TRUE, p.adjust.method = "BH", paired = FALSE, detailed = TRUE)
t_results <- rbind(t_results, pwc)
}

t_results$Shapiro_Wilk1 <- c(shapiro.test(x =ng5_df[["x200bp-500bp"]][1:3])$p.value, shapiro.test(x =ng5_df[["x200bp-500bp"]][1:3])$p.value, shapiro.test(x =ng5_df[["x200bp-500bp"]][4:6])$p.value, shapiro.test(x =ng5_df[["x500bp-1000bp"]][1:3])$p.value, shapiro.test(x =ng5_df[["x500bp-1000bp"]][1:3])$p.value, shapiro.test(x =ng5_df[["x500bp-1000bp"]][4:6])$p.value)

t_results$Shapiro_Wilk2 <- c(shapiro.test(x =ng5_df[["x200bp-500bp"]][4:6])$p.value, shapiro.test(x =ng5_df[["x200bp-500bp"]][7:9])$p.value, shapiro.test(x =ng5_df[["x200bp-500bp"]][7:9])$p.value, shapiro.test(x =ng5_df[["x500bp-1000bp"]][4:6])$p.value, shapiro.test(x =ng5_df[["x500bp-1000bp"]][7:9])$p.value, shapiro.test(x =ng5_df[["x500bp-1000bp"]][7:9])$p.value)

f1 <- cohen.d(ng5_df[["x200bp-500bp"]][1:3], ng5_df[["x200bp-500bp"]][4:6], hedges.correction = TRUE, pooled = TRUE, paired = FALSE)
f1 <- paste0(round(f1$estimate, digits = 3), " ", "(", f1$magnitude, ")")
f2 <- cohen.d(ng5_df[["x200bp-500bp"]][1:3], ng5_df[["x200bp-500bp"]][7:9], hedges.correction = TRUE, pooled = TRUE, paired = FALSE)
f2 <- paste0(round(f2$estimate, digits = 3), " ", "(", f2$magnitude, ")")
f3 <- cohen.d(ng5_df[["x200bp-500bp"]][4:6], ng5_df[["x200bp-500bp"]][7:9], hedges.correction = TRUE, pooled = TRUE, paired = FALSE)
f3 <- paste0(round(f3$estimate, digits = 3), " ", "(", f3$magnitude, ")")
f4 <- cohen.d(ng5_df[["x500bp-1000bp"]][1:3], ng5_df[["x500bp-1000bp"]][4:6], hedges.correction = TRUE, pooled = TRUE, paired = FALSE)
f4 <- paste0(round(f4$estimate, digits = 3), " ", "(", f4$magnitude, ")")
f5 <- cohen.d(ng5_df[["x500bp-1000bp"]][1:3], ng5_df[["x500bp-1000bp"]][7:9], hedges.correction = TRUE, pooled = TRUE, paired = FALSE)
f5 <- paste0(round(f5$estimate, digits = 3), " ", "(", f5$magnitude, ")")
f6 <- cohen.d(ng5_df[["x500bp-1000bp"]][4:6], ng5_df[["x500bp-1000bp"]][7:9], hedges.correction = TRUE, pooled = TRUE, paired = FALSE)
f6 <- paste0(round(f6$estimate, digits = 3), " ", "(", f6$magnitude, ")")

t_results$effect_size <- c(f1, f2, f3, f4, f5, f6)
t_results$Levenes_Test <- round(c(leveneTest(`x200bp-500bp` ~ primer, data = ng5_df[ng5_df$primer %in% c("5ng_18mer", "5ng_6mer"), ])$`Pr(>F)`[1], leveneTest(`x200bp-500bp` ~ primer, data = ng5_df[ng5_df$primer %in% c("5ng_18mer", "5ng_mix"), ])$`Pr(>F)`[1], leveneTest(`x200bp-500bp` ~ primer, data = ng5_df[ng5_df$primer %in% c("5ng_mix", "5ng_6mer"), ])$`Pr(>F)`[1], leveneTest(`x500bp-1000bp` ~ primer, data = ng5_df[ng5_df$primer %in% c("5ng_18mer", "5ng_6mer"), ])$`Pr(>F)`[1], leveneTest(`x500bp-1000bp` ~ primer, data = ng5_df[ng5_df$primer %in% c("5ng_18mer", "5ng_mix"), ])$`Pr(>F)`[1], leveneTest(`x500bp-1000bp` ~ primer, data = ng5_df[ng5_df$primer %in% c("5ng_mix", "5ng_6mer"), ])$`Pr(>F)`[1]), digits = 3)
ng5 <- t_results %>% dplyr::select(group1, group2, .y., Shapiro_Wilk1, Shapiro_Wilk2, Levenes_Test, method, p.adj, p.adj.signif, effect_size) %>% dplyr::rename(feature = .y.) %>% dplyr::rename(Hedges_g_effect_size = effect_size) 

ng5_181 <- ng5_df %>% pairwise_wilcox_test(`x75bp-200bp` ~ primer, p.adjust.method = "BH", paired = FALSE, detailed = TRUE) 

ng5_182 <- ng5_df %>% dplyr::filter(primer != "5ng_18mer") %>% pairwise_t_test(`x75bp-200bp` ~ primer, pool.sd = TRUE, p.adjust.method = "BH", paired = FALSE, detailed = TRUE) 

ng5_18 <- ng5_181 %>% dplyr::mutate(p.adj = if_else(group1 == "5ng_6mer" & group2 == "5ng_mix", ng5_182$p.adj, p.adj)) %>% dplyr::select(-c(estimate, statistic, conf.low, conf.high, n1, n2, p, alternative))

ng5_18$Levenes_Test <- round(c(leveneTest(`x75bp-200bp` ~ primer, data = ng5_df[ng5_df$primer %in% c("5ng_18mer", "5ng_6mer"), ])$`Pr(>F)`[1], leveneTest(`x75bp-200bp` ~ primer, data = ng5_df[ng5_df$primer %in% c("5ng_18mer", "5ng_mix"), ])$`Pr(>F)`[1], leveneTest(`x75bp-200bp` ~ primer, data = ng5_df[ng5_df$primer %in% c("5ng_mix", "5ng_6mer"), ])$`Pr(>F)`[1]), digits = 3)

ng5_18$Shapiro_Wilk1 <- c(shapiro.test(x =ng5_df[["x75bp-200bp"]][1:3])$p.value, shapiro.test(x =ng5_df[["x75bp-200bp"]][1:3])$p.value, shapiro.test(x =ng5_df[["x75bp-200bp"]][4:6])$p.value)

ng5_18$Shapiro_Wilk2 <- c(shapiro.test(x =ng5_df[["x75bp-200bp"]][4:6])$p.value, shapiro.test(x =ng5_df[["x75bp-200bp"]][7:9])$p.value, shapiro.test(x =ng5_df[["x75bp-200bp"]][7:9])$p.value)

f1 <- cohen.d(ng5_df[["x75bp-200bp"]][1:3], ng5_df[["x75bp-200bp"]][4:6], hedges.correction = TRUE, pooled = TRUE, paired = FALSE)
f1 <- paste0(round(f1$estimate, digits = 3), " ", "(", f1$magnitude, ")")
f2 <- cohen.d(ng5_df[["x75bp-200bp"]][1:3], ng5_df[["x75bp-200bp"]][7:9], hedges.correction = TRUE, pooled = TRUE, paired = FALSE)
f2 <- paste0(round(f2$estimate, digits = 3), " ", "(", f2$magnitude, ")")
f3 <- cohen.d(ng5_df[["x75bp-200bp"]][4:6], ng5_df[["x75bp-200bp"]][7:9], hedges.correction = TRUE, pooled = TRUE, paired = FALSE)
f3 <- paste0(round(f3$estimate, digits = 3), " ", "(", f3$magnitude, ")")
ng5_18$effect_size <- c(f1, f2, f3)
ng5_18 <- ng5_18 %>% dplyr::rename(feature = .y.) %>% dplyr::rename(Hedges_g_effect_size = effect_size) 

ng5_stats <- rbind(ng5_18, ng5) %>% dplyr::select(group1, group2, feature, Shapiro_Wilk1, Shapiro_Wilk2, Levenes_Test, method, p.adj, p.adj.signif, Hedges_g_effect_size)
ng5_stats$method <- ifelse(ng5_stats$Shapiro_Wilk1 < 0.05 | ng5_stats$Shapiro_Wilk2 < 0.05, "Mann–Whitney U test", "Student's t-test") 
###

t_results <- c()
for (i in colnames(ng20_df)[c(2, 3, 4)]){
formula <- reformulate("primer", response = i)
pwc <- ng20_df %>% pairwise_t_test(formula, pool.sd = TRUE, p.adjust.method = "BH", paired = FALSE, detailed = TRUE)
t_results <- rbind(t_results, pwc)
}

t_results$Shapiro_Wilk1 <- c(shapiro.test(x =ng20_df[["x75bp-200bp"]][1:3])$p.value, shapiro.test(x =ng20_df[["x75bp-200bp"]][1:3])$p.value, shapiro.test(x =ng20_df[["x75bp-200bp"]][4:6])$p.value, shapiro.test(x =ng20_df[["x200bp-500bp"]][1:3])$p.value, shapiro.test(x =ng20_df[["x200bp-500bp"]][1:3])$p.value, shapiro.test(x =ng20_df[["x200bp-500bp"]][4:6])$p.value, shapiro.test(x =ng20_df[["x500bp-1000bp"]][1:3])$p.value, shapiro.test(x =ng20_df[["x500bp-1000bp"]][1:3])$p.value, shapiro.test(x =ng20_df[["x500bp-1000bp"]][4:6])$p.value)

t_results$Shapiro_Wilk2 <- c(shapiro.test(x =ng20_df[["x75bp-200bp"]][4:6])$p.value, shapiro.test(x =ng20_df[["x75bp-200bp"]][7:9])$p.value, shapiro.test(x =ng20_df[["x75bp-200bp"]][7:9])$p.value, shapiro.test(x =ng20_df[["x200bp-500bp"]][4:6])$p.value, shapiro.test(x =ng20_df[["x200bp-500bp"]][7:9])$p.value, shapiro.test(x =ng20_df[["x200bp-500bp"]][7:9])$p.value, shapiro.test(x =ng20_df[["x500bp-1000bp"]][4:6])$p.value, shapiro.test(x =ng20_df[["x500bp-1000bp"]][7:9])$p.value, shapiro.test(x =ng20_df[["x500bp-1000bp"]][7:9])$p.value)


f1 <- cohen.d(ng20_df[["x75bp-200bp"]][1:3], ng20_df[["x75bp-200bp"]][4:6], hedges.correction = TRUE, pooled = TRUE, paired = FALSE)
f1 <- paste0(round(f1$estimate, digits = 3), " ", "(", f1$magnitude, ")")
f2 <- cohen.d(ng20_df[["x75bp-200bp"]][1:3], ng20_df[["x75bp-200bp"]][7:9], hedges.correction = TRUE, pooled = TRUE, paired = FALSE)
f2 <- paste0(round(f2$estimate, digits = 3), " ", "(", f2$magnitude, ")")
f3 <- cohen.d(ng20_df[["x75bp-200bp"]][4:6], ng20_df[["x75bp-200bp"]][7:9], hedges.correction = TRUE, pooled = TRUE, paired = FALSE)
f3 <- paste0(round(f3$estimate, digits = 3), " ", "(", f3$magnitude, ")")
f4 <- cohen.d(ng20_df[["x200bp-500bp"]][1:3], ng20_df[["x200bp-500bp"]][4:6], hedges.correction = TRUE, pooled = TRUE, paired = FALSE)
f4 <- paste0(round(f4$estimate, digits = 3), " ", "(", f4$magnitude, ")")
f5 <- cohen.d(ng20_df[["x200bp-500bp"]][1:3], ng20_df[["x200bp-500bp"]][7:9], hedges.correction = TRUE, pooled = TRUE, paired = FALSE)
f5 <- paste0(round(f5$estimate, digits = 3), " ", "(", f5$magnitude, ")")
f6 <- cohen.d(ng20_df[["x200bp-500bp"]][4:6], ng20_df[["x200bp-500bp"]][7:9], hedges.correction = TRUE, pooled = TRUE, paired = FALSE)
f6 <- paste0(round(f6$estimate, digits = 3), " ", "(", f6$magnitude, ")")
f7 <- cohen.d(ng20_df[["x500bp-1000bp"]][1:3], ng20_df[["x500bp-1000bp"]][4:6], hedges.correction = TRUE, pooled = TRUE, paired = FALSE)
f7 <- paste0(round(f7$estimate, digits = 3), " ", "(", f7$magnitude, ")")
f8 <- cohen.d(ng20_df[["x500bp-1000bp"]][1:3], ng20_df[["x500bp-1000bp"]][7:9], hedges.correction = TRUE, pooled = TRUE, paired = FALSE)
f8 <- paste0(round(f8$estimate, digits = 3), " ", "(", f8$magnitude, ")")
f9 <- cohen.d(ng20_df[["x500bp-1000bp"]][4:6], ng20_df[["x500bp-1000bp"]][7:9], hedges.correction = TRUE, pooled = TRUE, paired = FALSE)
f9 <- paste0(round(f9$estimate, digits = 3), " ", "(", f9$magnitude, ")")

t_results$effect_size <- c(f1, f2, f3, f4, f5, f6, f7, f8, f9)
t_results$Levenes_Test <- round(c(leveneTest(`x75bp-200bp` ~ primer, data = ng20_df[ng20_df$primer %in% c("20ng_18mer", "20ng_6mer"), ])$`Pr(>F)`[1], leveneTest(`x75bp-200bp` ~ primer, data = ng20_df[ng20_df$primer %in% c("20ng_18mer", "20ng_mix"), ])$`Pr(>F)`[1], leveneTest(`x75bp-200bp` ~ primer, data = ng20_df[ng20_df$primer %in% c("20ng_mix", "20ng_6mer"), ])$`Pr(>F)`[1], leveneTest(`x200bp-500bp` ~ primer, data = ng20_df[ng20_df$primer %in% c("20ng_18mer", "20ng_6mer"), ])$`Pr(>F)`[1], leveneTest(`x200bp-500bp` ~ primer, data = ng20_df[ng20_df$primer %in% c("20ng_18mer", "20ng_mix"), ])$`Pr(>F)`[1], leveneTest(`x200bp-500bp` ~ primer, data = ng20_df[ng20_df$primer %in% c("20ng_mix", "20ng_6mer"), ])$`Pr(>F)`[1], leveneTest(`x500bp-1000bp` ~ primer, data = ng20_df[ng20_df$primer %in% c("20ng_18mer", "20ng_6mer"), ])$`Pr(>F)`[1], leveneTest(`x500bp-1000bp` ~ primer, data = ng20_df[ng20_df$primer %in% c("20ng_18mer", "20ng_mix"), ])$`Pr(>F)`[1], leveneTest(`x500bp-1000bp` ~ primer, data = ng20_df[ng20_df$primer %in% c("20ng_mix", "20ng_6mer"), ])$`Pr(>F)`[1]), digits = 3)
ng20 <- t_results %>% dplyr::select(group1, group2, .y., Shapiro_Wilk1, Shapiro_Wilk2, Levenes_Test, method, p.adj, p.adj.signif, effect_size) %>% dplyr::rename(feature = .y.) %>% dplyr::rename(Hedges_g_effect_size = effect_size) 

ng20_stats <- ng20
ng20_stats$method <- ifelse(ng20$Shapiro_Wilk1 < 0.05 | ng20$Shapiro_Wilk2 < 0.05, "Mann–Whitney U test", "Student's t-test")
```